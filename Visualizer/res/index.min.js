define(["exports","tslib","@hpcc-js/chart","@hpcc-js/comms","@hpcc-js/dgrid","@hpcc-js/layout","@hpcc-js/common","@hpcc-js/graph","@hpcc-js/other","@hpcc-js/composite","@hpcc-js/form","@hpcc-js/map"],function(e,i,o,t,s,r,n,u,a,l,p,c){"use strict";var h=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i.__extends(t,e),t}(r.Grid);h.prototype._class+=" visualizer_VisualizerGrid",h.prototype.publish("maxRowCount",1e4,"number");var d=function(r){function e(){var e=null!==r&&r.apply(this,arguments)||this;return e._filter={},e._table=new s.Table,e}return i.__extends(e,r),e.prototype.update=function(e,t){r.prototype.update.call(this,e,t)},e.prototype.render=function(e){var s=this;if(0===this._renderCount){var t=this.data().length;this.data().forEach(function(e,t){var i=e[0],r=(new o.Column).columns(["Field ID","Row Count"]).data(e[2].map(function(e){return[e.value,e.rowcount]})).on("click",function(e,t,r){r?s._filter[i]=e["Field ID"]:delete s._filter[i],s.refreshFilter()});s.setContent(0,t,r,e[0]+" ("+e[1]+")")}),this.setContent(t?1:0,0,this._table,"",2,t),this.refreshFilter()}return r.prototype.render.apply(this,arguments)},e.prototype.refreshFilter=function(){var r=this;t.Result.attach({baseUrl:this.baseUrl()},this.logicalFile(),void 0).fetchRows(0,this.maxRowCount(),!1,this._filter).then(function(e){var i=[],s={},t=e.map(function(t,e){var r=[];return 0===e&&Object.keys(t).forEach(function(e,t){i.push(e),s[e]=t}),Object.keys(t).forEach(function(e){r[s[e]]=t[e]}),r});r._table.columns(i).data(t).render()})},e.prototype.click=function(e,t,r){},e}(h);d.prototype._class+=" visualizer_Dashboard",d.prototype.publish("baseUrl",null,"string"),d.prototype.publish("logicalFile",null,"string");var f="__hpcc_visualization",g=function(r){function e(e){var t=r.call(this)||this;return t._id="",t._columns=[],t._data=[],t._metaResult=e,t._id=t._metaResult.name(),t._columns=[],t._data=[],t}return i.__extends(e,r),e.prototype.mapData=function(e){var o=this.mappings();return o.length?e.map(function(e){for(var t={},r=0,i=o;r<i.length;r++){var s=i[r];t[s.key]=e[s.value.toLowerCase()]}return t}):e},e.prototype.refreshData=function(r,e){var t=this;void 0===r&&(r={}),void 0===e&&(e=-1);var i,s={},o=!1,n=0;(this.filteredBy().forEach(function(e){var t=r[e.source+f];t&&(++n,e.mappings.forEach(function(e){s[e.value.toLowerCase()]=t.row[e.key]||t.row[e.key.toLowerCase()]})),o=!0},this),!o||0<n)?i=a.createResult(this._metaResult.url(),this.dataSource(),this.resultName()).query({Start:0,Count:e},s).then(function(e){return a.flattenResult(e,t.mappings())}):i=Promise.resolve({columns:[],data:[]});return i},e}(n.PropertyExt);g.prototype._class+=" WUWudget",g.prototype.publish("widgetClassID",null,"string","ESP Url"),g.prototype.publish("widgetClass",null,"object","Widget Class Declaration"),g.prototype.publish("dataSource",null,"string","Data Source"),g.prototype.publish("resultName",null,"string","Result Name"),g.prototype.publish("mappings",null,"object","Widget Mappings"),g.prototype.publish("filteredBy",null,"object","Widget Filter Properties"),g.prototype.publish("properties",null,"object","Widget Properties");var y=function(r){function e(e){var t=r.call(this)||this;return t._id="",t._columns=[],t._data=[],t._metaResult=e,t._id=t._metaResult.name(),t._columns=[],t._data=[],t}return i.__extends(e,r),e.prototype.createWidget=function(){var t=(new(this.widgetClass())).id(this.id());return this.properties().forEach(function(e){"function"==typeof t[e.key]&&t[e.key](e.value)}),t},e.prototype.parseClassID=function(e){var t=e.split("_");return{pkg:"@hpcc-js/"+t[0],def:t[1]}},e.prototype.requireWidget=function(i){var s=this;return new Promise(function(t,e){var r=s.parseClassID(i);if("@hpcc-js/visualizer"===r.pkg)switch(r.def){case"Dashboard":t(d)}else require([r.pkg],function(e){t(e[r.def])})})},e.prototype.resolveWidget=function(){var t=this;return this.requireWidget(t.widgetClassID()).then(function(e){t.widgetClass(e)})},e.prototype.resolve=function(){var t=this;return this._metaResult.query().then(function(e){return e&&e.length?e[0].vertices?t.widgetClassID(e[0].classid).verticesMeta(new g(t._metaResult).widgetClassID(e[0].vertices[0].classid).dataSource(e[0].vertices[0].datasource||t._metaResult.wuid()).resultName(e[0].vertices[0].resultname).mappings(e[0].vertices[0].mappings).filteredBy(e[0].vertices[0].filteredby).properties(e[0].vertices[0].properties)).edgesMeta(new g(t._metaResult).widgetClassID(e[0].edges[0].classid).dataSource(e[0].edges[0].datasource||t._metaResult.wuid()).resultName(e[0].edges[0].resultname).mappings(e[0].edges[0].mappings).filteredBy(e[0].edges[0].filteredby).properties(e[0].edges[0].properties)).filteredBy(e[0].filteredby).properties(e[0].properties):(e[0].properties.push({key:"baseUrl",value:t._metaResult._protocol+"//"+t._metaResult._host+"/"}),t.widgetClassID(e[0].classid).widgetMeta(new g(t._metaResult).widgetClassID(e[0].classid).dataSource(e[0].datasource||t._metaResult.wuid()).resultName(e[0].resultname).mappings(e[0].mappings).filteredBy(e[0].filteredby).properties(e[0].properties)).filteredBy(e[0].filteredby).properties(e[0].properties)):console.log("Visualizer meta-data is empty."),t.resolveWidget().then(function(){return t})})},e.prototype.refreshData=function(e,t){var r=this;void 0===e&&(e={}),void 0===t&&(t=-1);var i=this.widget();return i instanceof u.Graph?Promise.all([this.verticesMeta().refreshData(e,t),this.edgesMeta().refreshData({},-1)]).then(function(e){return r.refreshGraph(i,e[0].data,r.verticesMeta().properties(),e[1].data,r.edgesMeta().properties())}):this.widgetMeta().refreshData(e,t).then(function(e){return r.refreshWidget(i,e)})},e.prototype.refreshWidget=function(e,t){e.columns(t.columns).data(t.data).lazyRender()},e.prototype.refreshGraph=function(e,t,r,i,s){var o={},n=t.map(function(e){var t=(new u.Vertex).text(e[1]);return e[2]?t.faChar(e[2]):t.icon_diameter(0),r.forEach(function(e){"function"==typeof t[e.key]&&t[e.key](e.value)}),o[e[0]]=t}),a=i.map(function(e){var t=o[e[0]],r=o[e[1]];if(t&&r){var i=(new u.Edge).sourceVertex(t).targetVertex(r).text(e[2]);return e[2]&&i.text(e[2]),s.forEach(function(e){"function"==typeof i[e.key]&&i[e.key](e.value)}),i}t?console.log("Invalid edge - no target vertex."):r?console.log("Invalid edge - no source vertex."):console.log("Invalid edge - no source or target verticies.")}).filter(function(e){return!!e});e.data({vertices:n,edges:a}).lazyRender()},e}(n.Widget);y.prototype._class+=" WUWudget",y.prototype.publish("widgetClassID",null,"string"),y.prototype.publish("widgetClass",null,"object","Widget Class Declaration"),y.prototype.publish("widget",null,"object","Widget Instance"),y.prototype.publish("widgetMeta",null,"object"),y.prototype.publish("verticesMeta",null,"object"),y.prototype.publish("edgesMeta",null,"object"),y.prototype.publish("filteredBy",null,"object","Widget Filter Properties"),y.prototype.publish("properties",null,"object","Widget Properties"),c.topoJsonFolder("https://unpkg.com/@hpcc-js/map@2.0.0/TopoJSON"),a.enableCache(!0);var _="HPCC-Visualizer",v="persist",m=function(){function e(e){this._wuWidgets=[],this._wuWidgetMap={},this._wuDashSel={},this._espUrl=e,this._espWorkunit=a.createConnection(this._espUrl),this._wuWidgets=[],this._wuWidgetMap={},this._wuDashSel={}}return e.prototype.resetPersist=function(){return this._espWorkunit.appData(_,v," ")},e.prototype.submitPersist=function(){if(this.grid){var e=a.Persist.serialize(this.grid);this._espWorkunit.appData(_,v,e)}},e.prototype.fetchPersist=function(){return this._espWorkunit.appData(_,v).then(function(e){if(e){var t=JSON.parse(e);switch(t.__class){case"visualizer_Dashboard":return l.Persist.deserializeFromObject(new d,t);case"visualizer_VisualizerGrid":return l.Persist.deserializeFromObject(new h,t);default:return l.Persist.create(e)}}return Promise.resolve(null)}).catch(function(e){return Promise.resolve(null)})},e.prototype.fetchWUWidgets=function(){return this._espWorkunit.results().then(function(e){var r=[];return e.filter(function(e){return n.Utility.endsWith(e.name(),f)}).forEach(function(e){var t=new y(e);r.push(t.resolve())}),Promise.all(r)})},e.prototype.createGrid=function(){var n=this;return Promise.all([this.fetchPersist(),this.fetchWUWidgets()]).then(function(e){n.grid=e[0],n._wuWidgets=[],n._wuWidgetMap={};var t=e[1];if(!n.grid){if(1===t.length&&t[0].widgetClass()===d)return n.grid=t[0].createWidget(),t[0].widget(n.grid),t[0].refreshData({},n.grid.maxRowCount()).then(function(){return n.grid});n.grid=new h}var o=Math.ceil(Math.sqrt(t.length)),r=Math.ceil(t.length/o),i=3*(o+1),s=3*(r+1);return n.grid.snappingColumns(i).snappingRows(s),t.forEach(function(e,t){var r=n.grid.getContent(e.id());if(!r){var i=0,s=0;for(r=e.createWidget();null!==n.grid.getCell(3*i,3*s);)o<=++s&&(s=0,++i);n.grid.setContent(3*i,3*s,r,null,3,3)}switch(r.classID()){case"graph_Graph":r.on("vertex_click",function(e,t,r){n.refreshFilters(this.id(),e,t,r)});break;default:r.on("click",function(e,t,r){n.refreshFilters(this.id(),e,t,r)})}(r._wuMeta=e).widget(r),n._wuWidgets.push(e),n._wuWidgetMap[e.id()]=e}),n.grid})},e.prototype.refresh=function(){var t=this;this._wuWidgets.forEach(function(e){e.refreshData(t._wuDashSel,t.grid.maxRowCount())})},e.prototype.refreshFilters=function(r,e,t,i){var s=this;i?this._wuDashSel[r]={row:e,col:t}:delete this._wuDashSel[r],this._wuWidgets.forEach(function(t){t.filteredBy().forEach(function(e){r===e.source+f&&t.refreshData(s._wuDashSel,s.grid.maxRowCount())})})},e}(),w=function(e){function t(){return e.call(this)||this}return i.__extends(t,e),t.prototype.toggleProperties=function(){var e=l.Dermatology.prototype.toggleProperties.apply(this,arguments);return this._showProperties||this.wuDashboard.submitPersist(),e},t.prototype.reset=function(){var t=this;this.wuDashboard.resetPersist().then(function(e){a.cache({}),delete t._prevEspUrl,t.render(function(e){})})},t.prototype.enter=function(){l.Dermatology.prototype.enter.apply(this,arguments);var e=this;this._resetButton=(new p.Button).id(this.id()+"_reset").value("Reset").on("click",function(){e.reset()}),this._toolbar.widgets([this._resetButton,this._propsButton])},t.prototype.update=function(){if(l.Dermatology.prototype.update.apply(this,arguments),this._prevEspUrl!==this.espUrl()){this._prevEspUrl=this.espUrl(),this.espCache()&&a.cache(JSON.parse(this.espCache()));var t=this;this.wuDashboard=new m(this.espUrl()),this.wuDashboard.createGrid().then(function(e){t.widget(e).render(function(e){t.wuDashboard.refresh()})})}},t}(l.Dermatology);w.prototype._class+=" BundleDermatology",w.prototype.publish("espUrl",null,"string","ESP Url"),w.prototype.publish("espCache",null,"string","ESP Cache"),e.WUDashboard=m,e.BundleDermatology=w,Object.defineProperty(e,"__esModule",{value:!0})});